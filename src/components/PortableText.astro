---
import type { PortableTextBlock, PortableTextTextBlock, PortableTextMarkDefinition } from '@sanity/types'

interface Props {
  blocks: PortableTextBlock[]
}

const { blocks } = Astro.props

function renderMarks(text: string, marks: string[] = [], markDefs: PortableTextMarkDefinition[] = []): string {
  let result = text

  for (const mark of marks || []) {
    switch (mark) {
      case 'strong':
        result = `<strong>${result}</strong>`
        break
      case 'em':
        result = `<em>${result}</em>`
        break
      case 'code':
        result = `<code class="bg-gray-100 dark:bg-gray-800 px-1 py-0.5 rounded text-sm font-mono text-pink-600 dark:text-pink-400">${result}</code>`
        break
      case 'underline':
        result = `<u>${result}</u>`
        break
      case 'strike-through':
        result = `<s>${result}</s>`
        break
      default:
        // Check if it's a link mark
        const markDef = markDefs?.find((md: any) => md._key === mark)
        if (markDef && markDef._type === 'link') {
          result = `<a href="${markDef.href}" class="text-blue-600 dark:text-blue-400 hover:underline" target="_blank" rel="noopener noreferrer">${result}</a>`
        }
    }
  }

  return result
}

function renderBlock(block: PortableTextBlock): string {
  const children = (block as PortableTextTextBlock).children
  const markDefs = (block as any).markDefs || []
  if (!children || children.length === 0) return ''

  // Render each child with its marks
  const text = children.map((child: any) => {
    if (child.text) {
      return renderMarks(child.text, child.marks, markDefs)
    }
    return ''
  }).join('')

  switch (block.style) {
    case 'h1':
      return `<h1 class="text-3xl font-bold mb-4 mt-6">${text}</h1>`
    case 'h2':
      return `<h2 class="text-2xl font-bold mb-3 mt-5">${text}</h2>`
    case 'h3':
      return `<h3 class="text-xl font-bold mb-2 mt-4">${text}</h3>`
    case 'h4':
      return `<h4 class="text-lg font-bold mb-2 mt-4">${text}</h4>`
    case 'blockquote':
      return `<blockquote class="border-l-4 border-gray-300 dark:border-gray-600 pl-4 italic my-4 text-gray-700 dark:text-gray-300">${text}</blockquote>`
    case 'normal':
    default:
      if (block.listItem) {
        if (block.listItem === 'bullet') {
          return `<li class="ml-4">${text}</li>`
        } else if (block.listItem === 'number') {
          return `<li class="ml-4 list-decimal">${text}</li>`
        }
      }
      return `<p class="mb-4 leading-relaxed">${text}</p>`
  }
}

// Handle code blocks separately
function renderBlockContent(block: PortableTextBlock): string {
  if ((block as any)._type === 'code') {
    const codeBlock = block as any
    return `<pre class="bg-gray-900 text-gray-100 p-4 rounded-lg overflow-x-auto my-4"><code class="text-sm">${codeBlock.code?.replace(/</g, '&lt;').replace(/>/g, '&gt;') || ''}</code></pre>`
  }
  return renderBlock(block)
}
---

<div class="prose prose-lg dark:prose-invert max-w-none prose-headings:font-bold prose-a:text-blue-600 dark:prose-a:text-blue-400 prose-strong:font-bold prose-em:italic prose-code:text-pink-600 dark:prose-code:text-pink-400">
  {
    blocks.map((block) => (
      <div set:html={renderBlockContent(block)} />
    ))
  }
</div>
